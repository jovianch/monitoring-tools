<template name="project">
  <script>
        function showOpenModal() {
            bootbox.dialog({
                title: "Open a Method",
                onEscape: true,
                message: $(".openfile").html(),
                buttons: [
                {
                    label: "OK",
                    className: "btn btn-primary pull-left",
                    callback: function() {
                        var files = $('input#selectFiles.form-control-file', '.bootbox').get(0).files;
                        if (files.length <= 0) {
                            alert("Open File Error!");
                        }
                        var fr = new FileReader();
                        var result;
                        fr.onload = function(e) {
                            dataText = e.target.result;
                            dataText = dataText.replace(/\\n/g, "\\n"); 
                            dataText = dataText.replace(/\\'/g, "\\'");
                            dataText = dataText.replace(/\\"/g, '\\"');
                            dataText = dataText.replace(/\\&/g, "\\&");
                            dataText = dataText.replace(/\\r/g, "\\r");
                            dataText = dataText.replace(/\\t/g, "\\t");
                            dataText = dataText.replace(/\\b/g, "\\b");
                            dataText = dataText.replace(/\\f/g, "\\f");
                            result = JSON.parse(dataText);
                            console.log(result);
                            if(result.length != 1){
                                alert("File Corrupted!");
                            }
                            else{
                                result.forEach(function (item, index, array) {
                                    Methods.insert(item);
                                })
                            }
                        }
                        fr.readAsText(files.item(0));
                    }
                },
                {
                    label: "Cancel",
                    className: "btn btn-default pull-left",
                    callback: function() {
                        
                    }
                }
                ]
            });
        }
    </script>

    <div class="jumbotron text-center">
        <h1>CASE Tool for Monitoring with Essence</h1>
        <h3>Jovian Christianto - 13514101</h3>
    </div>

  	<h2>Create New Project</h2>

    <p>Project Name:</p>
    <input id="project_name" type="text" name="project_name">
    <p>Description:</p>
    <input id="description" type="text" name="description">
    <p>Start Date:</p>
    <input id="start_date" type="date" name="start_date">
    <p>End Date:</p>
    <input id="end_date" type="date" name="end_date">
    <p>List Method:</p>
    {{#each arrayify allMethods}}
      <li>{{this.value.methodname}}</li>
    {{/each}}
     <a href="/project" class="clickable" onclick="showOpenModal()">Open File</a>

      <div class="openfile" style="display:none;">
          <input type="file" class="form-control-file" id="selectFiles" align="center" style="width:100%; background-color: #ccffff;">
      </div>
    <p>Input Your Method Name:</p>
    <input id="method" type="text" name="method">
    <!-- <br>
    Last name:<br>
    <input type="text" name="lastname" value="Mouse">
    <br><br> -->
    <a href="/project"><input type="submit" value="Choose" onclick="submit()"></a>
    <br>

    <a href="/method">Back to Home</a>
    <h3>Update Your Activity</h3>
    <div class="activity">
    {{#each arrayify Activities}}
      <label>{{this.name}}</label>
      <input id="activity{{this.name}}" type="date" name="end_date">
      <br>
    {{/each}}
    </div>

    <div class="subalpha">
      <h3>Update Your Subalpha</h3>
      {{#each arrayify alphas}}
        {{#each arrayify this.value.subalphas}}
          <label>{{this.name}}</label>
          {{#if is_bounded this.value.bound}}
            <input id="subalpha{{this.name}}" type="number">
          {{else}}
            <input id="subalpha{{this.name}}" type="number" value="1">
          {{/if}}
        {{/each}}
      {{/each}}
    </div>
    <div class="workproduct">
        <h3>Update Your Work Product</h3>
        {{#each arrayify alphas}}
          {{#each arrayify this.value.workproducts}}
            <label>{{this.name}}</label>
            {{#if is_bounded this.value.bound}}
              <input id="workproduct{{this.name}}" type="number">
            {{else}}
              <input id="workproduct{{this.name}}" type="number" value="1">
            {{/if}}
          {{/each}}
        {{/each}}
    </div>
    <button class="submit_workproduct">Submit Workproduct</button>
    <div class="state_workproduct">
      <h3>Choose Your State</h3>
      {{#each workproduct in workproducts}}
        <label>{{workproduct.name}}</label>
        <select id="{{workproduct.name}}">
        {{#each states_workproduct workproduct.name}}
          <option value="{{this.name}}">{{this.name}}</option>
        {{/each}}
        </select>
      {{/each}}
    </div>
    <a href="/method"><button class="submit" id="submit">Submit</button></a>

    <script>
    function submit() {
            var methodname = document.getElementById('method').value;
            var method = Methods.findOne({"methodname":methodname});
            var projectname = document.getElementById('project_name').value;
            var description = document.getElementById('description').value;
            var startdate = document.getElementById('start_date').value;
            var enddate = document.getElementById('end_date').value;
            // console.log(method);
            // var name = document.getElementById('firstname').value;
            // console.log(name);
            // Projects.remove({});
            Projects.insert({"name" : projectname, "description" : description, "start_date" : startdate, "end_date" : enddate, "method" : method});
            console.log(Projects.findOne({"name" : projectname})._id);
            Session.set('project', Projects.findOne({"name" : projectname})._id);

            // var tbody = document.getElementById('activity');

            // var project = Session.get('project');
            // var arr_activity = arrayify(Projects.findOne({_id:project}).method.activityspaces);
            // tbody.innerHTML = "<h3>Your Activity</h3>";

            // for (var i = 0; i < arr_activity.length; i++) {
            //     var tr = "<label>" + arr_activity[i].name + "</label>";
            //     tr += "<input id='activity" + arr_activity[i].name +"' type='date' name='end_date";

            //     /* We add the table row to the table body */
            //     tbody.innerHTML += tr;
            // }
        }
    </script>
</template>